name: PyPI Cleanup Example
on:
  workflow_dispatch:
  push:
    branches:
      - "**"
  pull_request:
  release:
    types:
      - published

env:
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 1
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  TERMINATOR_SKIP_NPM_INSTALL: 0
  OTEL_SKIP_COLLECTOR_CHECK: true
  OTEL_RETRY_DURATION_MINS: 0

jobs:
  cleanup:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Google Chrome
        shell: pwsh
        run: |
          choco install googlechrome -y --ignore-checksums
          Start-Sleep -Seconds 5
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (-not (Test-Path $chromePath)) {
            Write-Error "Chrome is not installed"
          }
      - name: Prime Chrome profile (skip first-run UI)
        shell: pwsh
        run: |
          $chrome = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (-not (Test-Path $chrome)) { $chrome = "chrome.exe" }
          Start-Process $chrome "--no-first-run --no-default-browser-check --disable-search-engine-choice-screen --disable-fre" 
          Start-Sleep -Seconds 10
          Get-Process chrome -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          override: true
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install Node bindings deps
        shell: pwsh
        working-directory: packages/terminator-nodejs
        run: bun install --ignore-scripts || true
      - name: Build Node.js bindings
        shell: pwsh
        working-directory: packages/terminator-nodejs
        run: bun run build

      - name: Install extension via terminator workflow
        run: |
          cargo run --bin terminator -- mcp run crates/terminator/browser-extension/install_chrome_extension_ui.yml
        shell: pwsh
        timeout-minutes: 15
        continue-on-error: true

      - run: npm ci
        working-directory: examples/pypi_cleanup_workflow

      - run: npm run build
        working-directory: examples/pypi_cleanup_workflow

      - run: npm run run
        working-directory: examples/pypi_cleanup_workflow
        env:
          PYPI_UI_USERNAME: ${{ secrets.PYPI_UI_USERNAME }}
          PYPI_UI_PASSWORD: ${{ secrets.PYPI_UI_PASSWORD }}
          PYPI_UI_TOTP_SECRET: ${{ secrets.PYPI_UI_TOTP_SECRET }}
          PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
